<% @title ||= 'HITs overview'; title @title %>

<div class="row mb-5">
  <div class="col-12">
    <%= link_to dashboard_path, class: 'btn btn-secondary btn-lg' do %>
      Go back
    <% end %>
  </div>
</div>

<div class="row justify-content-center mb-4">
  <div class="col-12">
    <h2 class='mb-4'>Mturk HITs<%= @sandbox ? ' (sandbox)' : ' (production)'  %></h2>
  </div>
  <div class="col-md-6 mb-2">
    <div class="card">
      <div class="card-body">
        <div class="mb-2">
          <h4 class='mb-0'>Account balance</h4>$<%= num(@balance) %>
        </div>
        <div class="mb-2">
          <h4 class='mb-0'>Total number of HITs</h4><%= num(@num_hits) %>
        </div>
        <div class="mb-0">
          <h4 class='mb-0'>Number of reviewable HITs</h4><%= num(@num_hits_reviewable) %>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Options</h4>
        <div>
          <label class="switch">
            <input type="checkbox" id="production-checkbox" <%= @sandbox ? '' : ' checked="checked"' %>>
            <span class="slider round"></span>
            <span class='switch-label'>Production</span>
          </label>
        </div>
        <div>
          <label class="switch">
            <input type="checkbox" id="filtered-checkbox" <%= @filtered ? ' checked="checked"' : '' %>>
            <span class="slider round"></span>
            <span class='switch-label'>Filter</span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center mb-4">
  <div class="col-12">
    <div id="refresh-mturk-hits-group">
      <%= link_to update_cached_hits_mturk_hits_path(sandbox: @sandbox, filtered: @filtered, format: :js),
        id: 'refresh-mturk-hits',
        class: 'btn btn-secondary mr-2',
        remote: true do
          "Refresh&nbsp;&nbsp;#{fa_icon('refresh')}".html_safe
        end
      %>
    <% if not @last_updated.nil? %>
      <%= 'Updated ' + time_ago_in_words(@last_updated) + ' ago' %>
    <% end %>
    </div>
    <div id="refresh-mturk-hits-group-running" style="display:none;">
      <div class="spinner mr-3" id="refresh-mturk-hits-spinner" style='display:inline-block;'></div>
      <div id="refresh-mturk-hits-spinner-info" class='mt-1' style='display:inline-block;margin:auto;position:absolute;'>Hello</div>
    </div>
  </div>
</div>


<div class="row justify-content-center mb-4">
  <div class="col-12">
    <%= paginate @hits %>
    <table class="table">
      <thead>
        <tr>
          <th></th>
          <th>Title</th>
          <th>Hit ID/<br>Task</th>
          <th>Hit Type ID/<br>Batch Job</th>
          <th>Status</th>
          <th>Review status</th>
          <th>Creation time</th>
          <th>Review actions</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @hits.each_with_index do |hit, index| %>
          <tr>
            <td><%= ((params[:page] || 1).to_i - 1) * 50 + index %></td>
            <td><%= hit.title %></td>
            <td><%= find_task(hit.hit_id) %></td>
            <td>
              <% if batch_job_exists_for_hit?(hit.hit_id) %>
                <%= find_batch_job(hit.hit_id)%>
                <% else %>
                  <%= hit.hit_type_id %>
              <% end %>
            </td>
            <td><%= hit.hit_status %></td>
            <td><%= hit.hit_review_status %></td>
            <td><%= time_ago_in_words(hit.creation_time) + ' ago' %></td>
            <td>
              <span>
                <% if can? :update, :mturk_hit and batch_job_exists_for_hit?(hit[:hit_id])%>
                  <%= link_to 'Review batch', mturk_reviewable_hits_path(hit_type_id: hit[:hit_type_id], sandbox: @sandbox, come_from: 'mturk_hits') %>
                <% end %>
              </span>
            </td>
            <td>
              <span>
                <% if can? :read, :mturk_hit %>
                  <%= link_to fa_icon("eye"), mturk_hit_path(hit[:hit_id], sandbox: @sandbox),
                    title: 'Show HIT details' %>
                <% end %>
              
                <% if can? :destroy, :mturk_hit %>
                  <%= link_to fa_icon("trash"), mturk_hit_path(hit[:hit_id], sandbox: @sandbox),
                    title: 'Delete HIT on Mturk',
                    method: :delete,
                    data: {confirm: "Delete HIT?"} %>
                <% end %>
              </span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
